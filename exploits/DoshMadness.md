# General information

No restrictions for dosh tossing over a short period of time results in the following list of exploits:

1. Ability to bypass collision checks of almost all actors in the level, allowing players to reach the unreachable places.
2. Instantly kill *any* zeds.
3. Lag clients, crash servers.

# Detailed exploits description

## Exploits reasons

`KFMod/KFPawn.uc#2964`

```unrealscript
exec function TossCash( int Amount )
{

    ...

    if( Amount<=0 )
        Amount = 50;
    Controller.PlayerReplicationInfo.Score = int(Controller.PlayerReplicationInfo.Score); // To fix issue with throwing 0 pounds.
    if( Controller.PlayerReplicationInfo.Score<=0 || Amount<=0 )
        return;
    Amount = Min(Amount,int(Controller.PlayerReplicationInfo.Score));

    ...

}
```

1. Not capping the minimum amount of dosh per toss. Which results in the ability to spawn as many `CashPickup` actors as your total dosh amount (by setting pickups value to £1.)
2. Since there's no timeout for `TossCash` execution, all the money can be tossed out very fast.

## #1: Collision bypass

Having tons of `CashPickup` actors concentrated in one spot is very calculation-heavy for the engine. Once the certain amount of actors is reached, the engine starts skipping calculation of collision between some of them. (It's what we came up with.)

Players can use this to bypass intended map-designers' blocks and reach the unreachable spots by going straight through static meshes, various blocking volumes, etc.

However, this doesn't work with:
- BSP Geometry
- Meshes with built-in blocking collision

[Video demonstration #1](https://www.youtube.com/watch?v=ie6ealc3-XA)

[Video demonstration #2](https://youtu.be/fbs7SBHWzlM)

[Video demonstration #3](https://youtu.be/mhQDbxvsH28)

## #2: Instant zed kill

Similarly to #1, players can use dosh to get inside zeds ignoring their collision. Once they are inside, they can duck to instantly kill the poor zed crushing it with their own collision. Be it a clot, a fleshpound, or even Patriarch.

[Video demonstration](https://youtu.be/FylKDUZnLDw)

## #3: Server crash

No matter how powerful the CPU of the server is, it can be overflown by an instant tossing of a huge amount of dosh.

Just sit, look at your feet and spam `TossCash` command as fast as you can.

£2500 will kill any server. £1500 is enough for the most. 500-700 can completely freeze the game until you stop throwing.

If you have 4k or more, you don't even need to look at your feet.

[Video demonstration](https://youtu.be/NGwXY79Ka0c)

# Proposed solution

Simply add a very small timeout after tossing.

After testing this with friends, we came up with `0.1f`. It prevents any dosh-related lags and exploits, even with 6 players tossing dosh simultaneously. At the same time, it's not very restrictive so you still can please your inner Michelangelo:

![Imgur](https://i.imgur.com/ITaG6xL.jpg)

Proposed fix:

```unrealscript
var transient float CashTossTimer,LongTossCashTimer;
var transient byte LongTossCashCount;

...
exec function TossCash( int Amount )
{
  ...

  if( Level.TimeSeconds < CashTossTimer || (Level.TimeSeconds < LongTossCashTimer && LongTossCashCount>=50) )
  {
    // maybe add a message so players wont be confused why they cant toss atm
    ClientMessage("Can't toss cash at the moment because you overspammed it faggot!",'CriticalEvent');
    return;
  }

  // all main code inbetween of these
  
  CashTossTimer = Level.TimeSeconds+0.1f;
  if( LongTossCashTimer<Level.TimeSeconds )
  {
    LongTossCashTimer = Level.TimeSeconds+4.f;
    LongTossCashCount = 0;
  }
  else
    ++LongTossCashCount;
}
```

TODO: Test this snippet and investigate 0.1f timeout. Maybe it can be done even less restrictive.

